"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.weeklyRecipeUpdate = void 0;
const firebase_functions_1 = require("firebase-functions");
const firebase_admin_1 = require("firebase-admin");
const firestore_1 = require("firebase-admin/firestore");
const utils_1 = require("./utils");
(0, firebase_admin_1.initializeApp)();
const db = (0, firestore_1.getFirestore)();
exports.weeklyRecipeUpdate = firebase_functions_1.scheduler.onSchedule('0 0 * * MON', async () => {
    const recipeSnapshot = await db.collection('/recipes').orderBy('lastCooked', 'desc').get();
    const recipesDoc = recipeSnapshot.docs.map((doc) => doc.data());
    const recipes = recipesDoc.filter((recipe) => recipe.tags.includes('EntrÃ©e'));
    const recipeMap = {};
    recipes.forEach((recipe) => {
        recipeMap[recipe.name] = recipe;
    });
    const LRURecipeDate = recipes[0].lastCooked;
    const LRURecipes = recipes.filter((recipe) => recipe.lastCooked.isEqual(LRURecipeDate));
    const randIndex = Math.floor(Math.random() * LRURecipes.length) ?? 0;
    const pickedRecipes = [(LRURecipes.at(randIndex) ?? LRURecipes[0]).name];
    const currentIngredients = (0, utils_1.proportionsToIngredientList)(recipeMap[pickedRecipes[0]].proportions);
    for (let i = 0; i < 6; i++) {
        const scores = recipes.map((recipe, index) => {
            let score = 0;
            let ingredientScore = 0;
            for (const prop of (0, utils_1.proportionsToIngredientList)(recipe.proportions)) {
                if (currentIngredients.includes(prop)) {
                    ingredientScore++;
                }
            }
            const dateScore = (recipe.lastCooked.toMillis() - (recipeMap[pickedRecipes[0]]?.lastCooked.toMillis() || 0)) / (1000 * 3600 * 24);
            let tagScore = 0;
            recipe.tags.forEach((tag) => {
                if ((0, utils_1.combineTags)(pickedRecipes, recipeMap).includes(tag))
                    tagScore++;
            });
            score = ingredientScore * 0.4 + dateScore * 0.4 + tagScore * 0.2;
            return [score, index];
        });
        scores.sort((a, b) => a[0] - b[0]);
        pickedRecipes.push(recipes[scores[0][1]].name);
        recipes.splice(scores[0][1], 1);
    }
    await db.doc('/website/weekly-recipes').update({
        recipes: pickedRecipes.map((recipe) => (0, utils_1.kebabCase)(recipe)),
    });
    const date = new Date();
    const timestamp = new firestore_1.Timestamp(date.getSeconds(), date.getMilliseconds());
    pickedRecipes.forEach(async (recipeName) => {
        await db.doc('/recipes/' + (0, utils_1.kebabCase)(recipeName)).update({
            lastCooked: timestamp,
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStDO0FBQy9DLG1EQUErQztBQUMvQyx3REFBbUU7QUFDbkUsbUNBQThFO0FBRTlFLElBQUEsOEJBQWEsR0FBRSxDQUFDO0FBQ2hCLE1BQU0sRUFBRSxHQUFHLElBQUEsd0JBQVksR0FBRSxDQUFDO0FBd0JiLFFBQUEsa0JBQWtCLEdBQUcsOEJBQVMsQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLEtBQUssSUFBSSxFQUFFO0lBRS9FLE1BQU0sY0FBYyxHQUFHLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzNGLE1BQU0sVUFBVSxHQUFhLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBUyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUVsRixNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBRTlFLE1BQU0sU0FBUyxHQUFjLEVBQUUsQ0FBQztJQUNoQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7UUFDekIsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBQzVDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7SUFDeEYsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyRSxNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUV6RSxNQUFNLGtCQUFrQixHQUFHLElBQUEsbUNBQTJCLEVBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBR2hHLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUUzQixNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxFQUFFO1lBQzNDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztZQUVkLElBQUksZUFBZSxHQUFHLENBQUMsQ0FBQztZQUN4QixLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUEsbUNBQTJCLEVBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7Z0JBQ25FLElBQUksa0JBQWtCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQ3RDLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixDQUFDO1lBQ0gsQ0FBQztZQUVELE1BQU0sU0FBUyxHQUNiLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFFbEgsSUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQzFCLElBQUksSUFBQSxtQkFBVyxFQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO29CQUFFLFFBQVEsRUFBRSxDQUFDO1lBQ3RFLENBQUMsQ0FBQyxDQUFDO1lBRUgsS0FBSyxHQUFHLGVBQWUsR0FBRyxHQUFHLEdBQUcsU0FBUyxHQUFHLEdBQUcsR0FBRyxRQUFRLEdBQUcsR0FBRyxDQUFDO1lBRWpFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRW5DLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRy9DLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFHRCxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDN0MsT0FBTyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUEsaUJBQVMsRUFBQyxNQUFNLENBQUMsQ0FBQztLQUMxRCxDQUFDLENBQUM7SUFFSCxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3hCLE1BQU0sU0FBUyxHQUFHLElBQUkscUJBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFJM0UsYUFBYSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUU7UUFDekMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFBLGlCQUFTLEVBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDdkQsVUFBVSxFQUFFLFNBQVM7U0FDdEIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHNjaGVkdWxlciB9IGZyb20gJ2ZpcmViYXNlLWZ1bmN0aW9ucyc7XHJcbmltcG9ydCB7IGluaXRpYWxpemVBcHAgfSBmcm9tICdmaXJlYmFzZS1hZG1pbic7XHJcbmltcG9ydCB7IGdldEZpcmVzdG9yZSwgVGltZXN0YW1wIH0gZnJvbSAnZmlyZWJhc2UtYWRtaW4vZmlyZXN0b3JlJztcclxuaW1wb3J0IHsgY29tYmluZVRhZ3MsIGtlYmFiQ2FzZSwgcHJvcG9ydGlvbnNUb0luZ3JlZGllbnRMaXN0IH0gZnJvbSAnLi91dGlscyc7XHJcblxyXG5pbml0aWFsaXplQXBwKCk7XHJcbmNvbnN0IGRiID0gZ2V0RmlyZXN0b3JlKCk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFByb3BvcnRpb24ge1xyXG4gIGluZ3JlZGllbnQ6IHN0cmluZ1xyXG4gIG1heFF0eTogc3RyaW5nXHJcbiAgbWluUXR5OiBzdHJpbmdcclxuICBxdWFudGl0eTogc3RyaW5nXHJcbiAgdW5pdDogc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVjaXBlIHtcclxuICBjb250ZW50Pzogc3RyaW5nXHJcbiAgY3JlYXRlZDogVGltZXN0YW1wXHJcbiAgbGFzdENvb2tlZDogVGltZXN0YW1wXHJcbiAgbmFtZTogc3RyaW5nXHJcbiAgcHJvcG9ydGlvbnM/OiBQcm9wb3J0aW9uW11cclxuICB0YWdzOiBzdHJpbmdbXVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBSZWNpcGVNYXAgPSB7W2tleTogc3RyaW5nXTogUmVjaXBlfVxyXG5cclxuLyoqXHJcbiAqIFdlZWtseSByZWNpcGUgdXBkYXRlIGZ1bmN0aW9ucyB0byB1cGRhdGUgdGhlIDcgd2Vla2x5IHJlY2lwZXMuIEl0IHJ1bnMgZXZlcnkgTW9uZGF5IGF0IG1pZG5pZ2h0LlxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IHdlZWtseVJlY2lwZVVwZGF0ZSA9IHNjaGVkdWxlci5vblNjaGVkdWxlKCcwIDAgKiAqIE1PTicsIGFzeW5jICgpID0+IHtcclxuLy8gZXhwb3J0IGNvbnN0IHdlZWtseVJlY2lwZVVwZGF0ZSA9IGh0dHBzLm9uUmVxdWVzdChhc3luYyAoXywgcmVzKSA9PiB7XHJcbiAgY29uc3QgcmVjaXBlU25hcHNob3QgPSBhd2FpdCBkYi5jb2xsZWN0aW9uKCcvcmVjaXBlcycpLm9yZGVyQnkoJ2xhc3RDb29rZWQnLCAnZGVzYycpLmdldCgpO1xyXG4gIGNvbnN0IHJlY2lwZXNEb2M6IFJlY2lwZVtdID0gcmVjaXBlU25hcHNob3QuZG9jcy5tYXAoKGRvYykgPT4gPFJlY2lwZT5kb2MuZGF0YSgpKTtcclxuXHJcbiAgY29uc3QgcmVjaXBlcyA9IHJlY2lwZXNEb2MuZmlsdGVyKChyZWNpcGUpID0+IHJlY2lwZS50YWdzLmluY2x1ZGVzKCdFbnRyw6llJykpO1xyXG5cclxuICBjb25zdCByZWNpcGVNYXA6IFJlY2lwZU1hcCA9IHt9O1xyXG4gIHJlY2lwZXMuZm9yRWFjaCgocmVjaXBlKSA9PiB7XHJcbiAgICByZWNpcGVNYXBbcmVjaXBlLm5hbWVdID0gcmVjaXBlO1xyXG4gIH0pO1xyXG5cclxuICBjb25zdCBMUlVSZWNpcGVEYXRlID0gcmVjaXBlc1swXS5sYXN0Q29va2VkO1xyXG4gIGNvbnN0IExSVVJlY2lwZXMgPSByZWNpcGVzLmZpbHRlcigocmVjaXBlKSA9PiByZWNpcGUubGFzdENvb2tlZC5pc0VxdWFsKExSVVJlY2lwZURhdGUpKTtcclxuICBjb25zdCByYW5kSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBMUlVSZWNpcGVzLmxlbmd0aCkgPz8gMDtcclxuICBjb25zdCBwaWNrZWRSZWNpcGVzID0gWyhMUlVSZWNpcGVzLmF0KHJhbmRJbmRleCkgPz8gTFJVUmVjaXBlc1swXSkubmFtZV07XHJcblxyXG4gIGNvbnN0IGN1cnJlbnRJbmdyZWRpZW50cyA9IHByb3BvcnRpb25zVG9JbmdyZWRpZW50TGlzdChyZWNpcGVNYXBbcGlja2VkUmVjaXBlc1swXV0ucHJvcG9ydGlvbnMpO1xyXG5cclxuICAvLyBmb3IgcGlja2luZyByZWNpcGUgZm9yIGVhY2ggZGF5IGFmdGVyIHRoZSByYW5kb21seSBwaWNrZWQgb25lXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHtcclxuICAgIC8vIHNjb3JlIGVhY2ggcmVjaXBlIGJhc2VkIG9uIHNpbWlsYXJpdHlcclxuICAgIGNvbnN0IHNjb3JlcyA9IHJlY2lwZXMubWFwKChyZWNpcGUsIGluZGV4KSA9PiB7XHJcbiAgICAgIGxldCBzY29yZSA9IDA7XHJcblxyXG4gICAgICBsZXQgaW5ncmVkaWVudFNjb3JlID0gMDtcclxuICAgICAgZm9yIChjb25zdCBwcm9wIG9mIHByb3BvcnRpb25zVG9JbmdyZWRpZW50TGlzdChyZWNpcGUucHJvcG9ydGlvbnMpKSB7XHJcbiAgICAgICAgaWYgKGN1cnJlbnRJbmdyZWRpZW50cy5pbmNsdWRlcyhwcm9wKSkge1xyXG4gICAgICAgICAgaW5ncmVkaWVudFNjb3JlKys7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIG51bWJlciBvZiBkYXlzIGJldHdlZW4gdGhlIHR3byBkYXRlc1xyXG4gICAgICBjb25zdCBkYXRlU2NvcmUgPVxyXG4gICAgICAgIChyZWNpcGUubGFzdENvb2tlZC50b01pbGxpcygpIC0gKHJlY2lwZU1hcFtwaWNrZWRSZWNpcGVzWzBdXT8ubGFzdENvb2tlZC50b01pbGxpcygpIHx8IDApKSAvICgxMDAwICogMzYwMCAqIDI0KTtcclxuXHJcbiAgICAgIGxldCB0YWdTY29yZSA9IDA7XHJcbiAgICAgIHJlY2lwZS50YWdzLmZvckVhY2goKHRhZykgPT4ge1xyXG4gICAgICAgIGlmIChjb21iaW5lVGFncyhwaWNrZWRSZWNpcGVzLCByZWNpcGVNYXApLmluY2x1ZGVzKHRhZykpIHRhZ1Njb3JlKys7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgc2NvcmUgPSBpbmdyZWRpZW50U2NvcmUgKiAwLjQgKyBkYXRlU2NvcmUgKiAwLjQgKyB0YWdTY29yZSAqIDAuMjtcclxuXHJcbiAgICAgIHJldHVybiBbc2NvcmUsIGluZGV4XTtcclxuICAgIH0pO1xyXG5cclxuICAgIHNjb3Jlcy5zb3J0KChhLCBiKSA9PiBhWzBdIC0gYlswXSk7XHJcbiAgICAvLyBhZGQgdGhlIHJlY2lwZSB3aXRoIHRoZSBsb3dlc3Qgc2NvcmVcclxuICAgIHBpY2tlZFJlY2lwZXMucHVzaChyZWNpcGVzW3Njb3Jlc1swXVsxXV0ubmFtZSk7XHJcblxyXG4gICAgLy8gcmVtb3ZlIHRoYXQgcmVjaXBlIHNvIHRoYXQgd2UgZG9uJ3QgdXNlIGl0IGFnYWluXHJcbiAgICByZWNpcGVzLnNwbGljZShzY29yZXNbMF1bMV0sIDEpO1xyXG4gIH1cclxuXHJcbiAgLy8gQWRkIG5hbWVzIG9mIHRoZSByZWNpcGVzIHBpY2tlZCB0aGlzIHdlZWsgdGhlIGRvY3VtZW50XHJcbiAgYXdhaXQgZGIuZG9jKCcvd2Vic2l0ZS93ZWVrbHktcmVjaXBlcycpLnVwZGF0ZSh7XHJcbiAgICByZWNpcGVzOiBwaWNrZWRSZWNpcGVzLm1hcCgocmVjaXBlKSA9PiBrZWJhYkNhc2UocmVjaXBlKSksXHJcbiAgfSk7XHJcblxyXG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gIGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBUaW1lc3RhbXAoZGF0ZS5nZXRTZWNvbmRzKCksIGRhdGUuZ2V0TWlsbGlzZWNvbmRzKCkpO1xyXG5cclxuICAvLyBBZGQgdGhlIGxhc3QgY29va2VkIGRhdGUgZm9yIGVhY2ggcGlja2VkIHJlY2lwZSB0byByaWdodCBub3csIGFuZCBtYWtlIHN1cmUgaXRzIHRoZSBzYW1lIHZhbHVlXHJcbiAgLy8gTmVlZCB0aGUgc2FtZSB2YWx1ZSBqdXN0IGJlY2F1c2Ugb2YgaG93IHRoZSBsb2dpYyBhYm92ZSB3b3Jrc1xyXG4gIHBpY2tlZFJlY2lwZXMuZm9yRWFjaChhc3luYyAocmVjaXBlTmFtZSkgPT4ge1xyXG4gICAgYXdhaXQgZGIuZG9jKCcvcmVjaXBlcy8nICsga2ViYWJDYXNlKHJlY2lwZU5hbWUpKS51cGRhdGUoe1xyXG4gICAgICBsYXN0Q29va2VkOiB0aW1lc3RhbXAsXHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdfQ==